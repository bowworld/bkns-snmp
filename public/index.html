<!DOCTYPE html>
<!-- VERSION: 1.0.1 - ADDED DUAL SCROLLBARS -->
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SNMP Viewer</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            margin-bottom: 3rem;
            text-align: center;
        }

        h1 {
            font-weight: 600;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .settings-container {
            position: absolute;
            top: 2rem;
            right: 2rem;
        }

        .settings-btn {
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            border-radius: 8px;
        }

        .settings-btn:hover {
            background: #f1f5f9;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 0.5rem;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1rem;
            min-width: 250px;
            z-index: 50;
        }

        .dropdown-content.show {
            display: block;
        }

        .controls-wrapper {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .controls {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: flex-start;
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            align-items: center;
        }

        .mib-panel {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .mib-panel h3 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
        }

        .mib-list {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.5rem;
        }

        .mib-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0;
            font-size: 0.875rem;
        }

        input[type="text"] {
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            flex: 1;
            min-width: 150px;
            transition: border-color 0.2s;
        }

        input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.1s, background-color 0.2s;
        }

        .btn-secondary {
            background-color: transparent;
            color: var(--primary);
            border: 1px solid var(--primary);
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .btn-secondary:hover {
            background-color: #eff6ff;
        }

        button:hover {
            background-color: var(--primary-hover);
        }

        .btn-secondary:hover {
            background-color: #eff6ff;
        }

        button:active {
            transform: translateY(1px);
        }

        button:disabled {
            background-color: var(--text-muted);
            cursor: not-allowed;
            opacity: 0.7;
        }

        .tables-container {
            display: grid;
            gap: 2rem;
        }

        .table-card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            overflow: hidden;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header h2 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-main);
        }

        .table-responsive {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        th,
        td {
            padding: 1rem 1.5rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background-color: #f8fafc;
            font-weight: 600;
            color: var(--text-muted);
            white-space: nowrap;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover td {
            background-color: #f1f5f9;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
            display: none;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--primary);
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .error-message {
            background-color: #fef2f2;
            color: #ef4444;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            text-align: center;
            display: none;
        }

        /* Dual Scrollbar Styles */
        .top-scroll-wrapper {
            overflow-x: auto;
            overflow-y: hidden;
            height: 12px;
            margin-bottom: 0;
            border-bottom: none;
            background: #f1f5f9;
            /* Light background for visibility */
        }

        .top-scroll-dummy {
            height: 1px;
        }

        .table-card {
            /* display: block is default, flex-shrink accounts for flex parent */
            flex-shrink: 0;
        }

        /* Fixed Layout Styles */
        html,
        body {
            height: 100vh;
            overflow: hidden;
        }

        .container {
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-sizing: border-box;
        }

        .top-section {
            flex: 0 0 auto;
            z-index: 20;
            position: relative;
            background-color: var(--bg);
            padding-bottom: 0.5rem;
        }

        /* Adjust margins to save space in fixed mode */
        header {
            margin-bottom: 1.5rem;
        }

        .controls-wrapper {
            margin-bottom: 1rem;
        }

        .tables-container {
            flex: 1 1 auto;
            overflow-y: auto;
            padding-right: 0.5rem;
            padding-bottom: 2rem;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 transparent;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .tables-container::-webkit-scrollbar {
            width: 8px;
        }

        .tables-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .tables-container::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
            border: 2px solid var(--bg);
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="top-section">
            <header>
                <h1>SNMP Data Viewer</h1>
                <p style="color: var(--text-muted);">Explore your network equipment data visually</p>
                <div class="settings-container">
                    <button id="settingsBtn" class="settings-btn">
                        <span>Settings</span>
                        <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                    <div id="settingsDropdown" class="dropdown-content">
                        <div style="padding: 0.5rem; border-radius: 8px;">
                            <input type="checkbox" id="hideNoDesc"
                                style="margin-right: 0.5rem; vertical-align: middle;">
                            <label for="hideNoDesc"
                                style="vertical-align: middle; font-size: 0.875rem; color: var(--text-main); cursor: pointer;">Hide
                                metrics without description</label>
                        </div>
                    </div>
                </div>
            </header>

            <div class="controls-wrapper">
                <div class="controls">
                    <input type="text" id="targetIp" placeholder="Target IP (e.g., 192.168.2.1)" value="192.168.2.1">
                    <input type="text" id="rootOid" placeholder="Root OID (Optional)" value="1.3.6.1.2.1">

                    <div style="display: flex; gap: 0.5rem; width: 100%; align-items: center;">
                        <select id="snmpVersion"
                            style="padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border); font-size: 1rem; background: white;">
                            <option value="">Select SNMP Version...</option>
                            <option value="1">SNMP v1</option>
                            <option value="2c">SNMP v2c</option>
                            <option value="3">SNMP v3</option>
                        </select>

                        <input type="text" id="community" placeholder="Community" value="public" style="flex: 2;">
                    </div>

                    <!-- SNMP v3 Fields (hidden by default) -->
                    <div id="v3Fields"
                        style="display: none; width: 100%; gap: 1rem; flex-direction: column; background: #f1f5f9; padding: 1rem; border-radius: 8px; margin-top: 0.5rem;">
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" id="v3User" placeholder="Username" value="user" style="width: 100%;">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                            <select id="v3AuthProto"
                                style="padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border);">
                                <option value="none">Auth: None</option>
                                <option value="md5">MD5</option>
                                <option value="sha">SHA</option>
                            </select>
                            <input type="password" id="v3AuthPwd" placeholder="Auth Password"
                                style="padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border);">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                            <select id="v3PrivProto"
                                style="padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border);">
                                <option value="none">Priv: None</option>
                                <option value="des">DES</option>
                                <option value="aes">AES128</option>
                                <option value="aes256">AES256</option>
                            </select>
                            <input type="password" id="v3PrivPwd" placeholder="Priv Password"
                                style="padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border);">
                        </div>
                    </div>

                    <button id="scanBtn" style="width: 100%;">Scan Device</button>
                </div>

                <div class="mib-panel">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>MIB Files</h3>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="file" id="mibUploadInput" style="display: none;" accept=".txt,.mib,.my">
                            <button id="uploadMibBtn" class="btn-secondary"
                                onclick="document.getElementById('mibUploadInput').click()">+ Upload</button>
                            <button id="deleteMibBtn" class="btn-secondary"
                                style="display: none; border-color: #ef4444; color: #ef4444;"
                                onclick="deleteSelectedMibs()">Delete</button>
                        </div>
                    </div>
                    <div id="mibList" class="mib-list">
                        <div style="padding: 0.5rem; color: var(--text-muted); text-align: center;">No MIBs found</div>
                    </div>
                </div>
            </div>

            <div id="errorBox" class="error-message"></div>

            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Scanning device... This may take a few seconds.</p>
                <button id="stopBtn" style="background-color: #ef4444; margin-top: 1rem;">Stop & Reset
                    Interface</button>
            </div>

            <div id="downloadContainer"
                style="display: none; margin-bottom: 1.5rem; text-align: right; gap: 1rem; justify-content: flex-end;">
                <button id="downloadTxtBtn"
                    style="background-color: var(--text-muted); padding: 0.5rem 1rem; font-size: 0.875rem;">Download
                    TXT</button>
                <button id="downloadCsvBtn" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Download CSV</button>
            </div>
        </div>

        <div id="results" class="tables-container"></div>
    </div>

    <script>
        const scanBtn = document.getElementById('scanBtn');
        const targetIp = document.getElementById('targetIp');
        const rootOid = document.getElementById('rootOid');
        const community = document.getElementById('community');
        const snmpVersion = document.getElementById('snmpVersion');
        const v3Fields = document.getElementById('v3Fields');
        const resultsDiv = document.getElementById('results');
        const loadingDiv = document.getElementById('loading');
        const errorBox = document.getElementById('errorBox');
        const mibListDiv = document.getElementById('mibList');
        const mibUploadInput = document.getElementById('mibUploadInput');
        const deleteMibBtn = document.getElementById('deleteMibBtn');
        const downloadContainer = document.getElementById('downloadContainer');
        const downloadTxtBtn = document.getElementById('downloadTxtBtn');
        const downloadCsvBtn = document.getElementById('downloadCsvBtn');
        const stopBtn = document.getElementById('stopBtn');

        let lastScanData = null;
        let abortController = null;
        const hideNoDescCheckbox = document.getElementById('hideNoDesc');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsDropdown = document.getElementById('settingsDropdown');

        if (settingsBtn) {
            settingsBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                settingsDropdown.classList.toggle('show');
            });

            document.addEventListener('click', (e) => {
                if (!settingsDropdown.contains(e.target) && !settingsBtn.contains(e.target)) {
                    settingsDropdown.classList.remove('show');
                }
            });
        }

        hideNoDescCheckbox.addEventListener('change', () => {
            if (lastScanData) {
                renderTables(lastScanData);
            }
        });

        // Stop button functionality
        stopBtn.addEventListener('click', () => {
            if (abortController) {
                abortController.abort();
            }
            location.reload(); // Quick and easy way to "reset interface" as requested
        });

        // Toggle v3 fields visibility
        snmpVersion.addEventListener('change', () => {
            if (snmpVersion.value === '3') {
                v3Fields.style.display = 'flex';
                community.style.display = 'none';
            } else {
                v3Fields.style.display = 'none';
                community.style.display = 'block';
            }
        });

        // Load available MIBs on start
        fetchMibs();

        mibUploadInput.addEventListener('change', async (e) => {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                const formData = new FormData();
                formData.append('mibFile', file);

                try {
                    const res = await fetch('/api/upload-mib', {
                        method: 'POST',
                        body: formData
                    });
                    if (res.ok) {
                        fetchMibs(); // Refresh list
                    } else {
                        const err = await res.json();
                        alert('Upload failed: ' + err.error);
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    alert('Upload failed.');
                }
                // Reset input
                e.target.value = '';
            }
        });

        async function fetchMibs() {
            try {
                const res = await fetch('/api/mibs');
                const files = await res.json();
                renderMibList(files);
            } catch (err) {
                console.error("Failed to fetch MIBs", err);
            }
        }

        function renderMibList(files) {
            if (files.length === 0) {
                mibListDiv.innerHTML = '<div style="padding: 0.5rem; color: var(--text-muted); text-align: center;">No MIBs found</div>';
                deleteMibBtn.style.display = 'none';
                return;
            }

            mibListDiv.innerHTML = '';
            files.forEach(file => {
                const div = document.createElement('div');
                div.className = 'mib-item';
                div.innerHTML = `
                    <input type="checkbox" id="mib-${file}" value="${file}" class="mib-checkbox" onchange="updateDeleteButtonVisibility()">
                    <label for="mib-${file}" style="cursor: pointer; overflow: hidden; text-overflow: ellipsis;">${file}</label>
                `;
                mibListDiv.appendChild(div);
            });
            updateDeleteButtonVisibility();
        }

        function updateDeleteButtonVisibility() {
            const selected = getSelectedMibs();
            deleteMibBtn.style.display = selected.length > 0 ? 'block' : 'none';
        }

        async function deleteSelectedMibs() {
            const selected = getSelectedMibs();
            if (selected.length === 0) return;

            if (!confirm(`Are you sure you want to delete ${selected.length} MIB file(s)?`)) return;

            try {
                const res = await fetch('/api/mibs', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ files: selected })
                });
                if (res.ok) {
                    fetchMibs(); // Refresh list
                } else {
                    const err = await res.json();
                    alert('Delete failed: ' + err.error);
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Delete failed.');
            }
        }

        function getSelectedMibs() {
            const checkboxes = document.querySelectorAll('.mib-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        scanBtn.addEventListener('click', async () => {
            const ip = targetIp.value.trim();
            const oid = rootOid.value.trim();
            const comm = community.value.trim();
            const selectedMibs = getSelectedMibs();
            const version = snmpVersion.value;

            if (!ip) {
                showError("Please enter a target IP address.");
                return;
            }

            if (!version) {
                showError("Please select an SNMP version protocol.");
                return;
            }

            setLoading(true);
            showError(null); // Clear errors
            resultsDiv.innerHTML = '';
            downloadContainer.style.display = 'none';
            lastScanData = null;

            try {
                let url = `/api/snmp-walk?target=${encodeURIComponent(ip)}&oid=${encodeURIComponent(oid)}&version=${version}`;

                if (version === '3') {
                    url += `&v3_user=${encodeURIComponent(document.getElementById('v3User').value)}`;
                    url += `&v3_auth_proto=${encodeURIComponent(document.getElementById('v3AuthProto').value)}`;
                    url += `&v3_auth_pwd=${encodeURIComponent(document.getElementById('v3AuthPwd').value)}`;
                    url += `&v3_priv_proto=${encodeURIComponent(document.getElementById('v3PrivProto').value)}`;
                    url += `&v3_priv_pwd=${encodeURIComponent(document.getElementById('v3PrivPwd').value)}`;
                } else {
                    url += `&community=${encodeURIComponent(comm)}`;
                }

                if (selectedMibs.length > 0) {
                    url += `&mibs=${encodeURIComponent(selectedMibs.join(','))}`;
                }

                // Create new AbortController for this request
                abortController = new AbortController();

                const response = await fetch(url, { signal: abortController.signal });
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to fetch data');
                }

                lastScanData = data;
                renderTables(data);

                // Show download button if ANY results were returned
                console.log("Checking data for button visibility:", data);
                if ((data.tables && data.tables.length > 0) || (data.raw && data.raw.length > 0)) {
                    console.log("Success: showing download button");
                    downloadContainer.style.setProperty('display', 'flex', 'important');
                } else {
                    console.warn("No data returned, button hidden");
                }

            } catch (err) {
                if (err.name === 'AbortError') {
                    console.log('Scan aborted by user');
                } else {
                    showError(err.message);
                }
            } finally {
                setLoading(false);
                abortController = null;
            }
        });

        function setLoading(isLoading) {
            if (isLoading) {
                loadingDiv.style.display = 'block';
                scanBtn.disabled = true;
                scanBtn.textContent = 'Scanning...';
            } else {
                loadingDiv.style.display = 'none';
                scanBtn.disabled = false;
                scanBtn.textContent = 'Scan Device';
            }
        }

        function showError(msg) {
            if (msg) {
                errorBox.textContent = msg;
                errorBox.style.display = 'block';
            } else {
                errorBox.style.display = 'none';
            }
        }

        function renderTables(data) {
            const { tables, raw } = data;
            resultsDiv.innerHTML = '';

            // 1. Render General Information (Raw results that are not in any table column)
            // We can identify these by checking which OIDs are in tables and which are not.
            const tableOids = new Set();
            if (tables) {
                tables.forEach(t => {
                    t.rows.forEach(r => {
                        t.columns.forEach(c => {
                            // This is a bit complex to reconstruct full OID from table structure easily
                            // But usually raw results are things like sysDescr, sysUpTime etc.
                        });
                    });
                });
            }

            // For now, let's just show all raw results if no tables, or a "Top level fields" section
            // A better way: show raw results that have short OIDs or are known scalars.

            // Actually, let's just render what's available.
            if (raw && raw.length > 0) {
                let scalarResults = raw.filter(r => {
                    // Heuristic: if it's part of a table, its OID will start with the table's entry OID
                    return !tables.some(t => t.tableOid && r.oid.startsWith(t.tableOid + '.'));
                });

                if (document.getElementById('hideNoDesc').checked) {
                    scalarResults = scalarResults.filter(r => r.description);
                }

                if (scalarResults.length > 0) {
                    const card = document.createElement('div');
                    card.className = 'table-card';
                    card.style.marginBottom = '2rem';
                    card.innerHTML = `<div class="card-header"><h2>General Information</h2></div>`;

                    const tableWrapper = document.createElement('div');
                    tableWrapper.className = 'table-responsive';
                    const tableEl = document.createElement('table');
                    tableEl.innerHTML = `
                        <thead>
                            <tr>
                                <th>Name / OID</th>
                                <th>Value</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${scalarResults.map(r => `
                                <tr>
                                    <td style="font-weight: 500;">${r.name || r.oid}</td>
                                    <td>${r.value}</td>
                                    <td style="color: var(--text-muted); font-size: 0.75rem;">${r.description || 'no description'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    `;
                    tableWrapper.appendChild(tableEl);
                    card.appendChild(tableWrapper);
                    resultsDiv.appendChild(card);
                }
            }

            if (!tables || tables.length === 0) {
                if (!raw || raw.length === 0) {
                    resultsDiv.innerHTML = '<div style="text-align: center; padding: 2rem; color: #64748b;">No data found.</div>';
                }
                return;
            }

            tables.forEach(table => {
                // Filter columns if needed
                let displayColumns = table.columns;
                if (document.getElementById('hideNoDesc').checked) {
                    displayColumns = displayColumns.filter(col => {
                        const desc = table.columnDescriptions && table.columnDescriptions[col] ? table.columnDescriptions[col] : '';
                        return desc && desc.length > 0;
                    });
                }

                // If no columns left, skip table
                if (displayColumns.length === 0) return;

                const card = document.createElement('div');
                card.className = 'table-card';

                const header = document.createElement('div');
                header.className = 'card-header';
                header.innerHTML = `<h2>Data Group: ${table.oid}</h2>`;
                card.appendChild(header);

                const topScrollWrapper = document.createElement('div');
                topScrollWrapper.className = 'top-scroll-wrapper';
                const topScrollDummy = document.createElement('div');
                topScrollDummy.className = 'top-scroll-dummy';
                topScrollWrapper.appendChild(topScrollDummy);
                card.appendChild(topScrollWrapper);

                const tableWrapper = document.createElement('div');
                tableWrapper.className = 'table-responsive';

                const tableEl = document.createElement('table');

                const thead = document.createElement('thead');
                const headRow = document.createElement('tr');

                const colHeaders = displayColumns.map(col => {
                    const name = table.columnNames && table.columnNames[col] ? table.columnNames[col] : `Col ${col}`;
                    const desc = table.columnDescriptions && table.columnDescriptions[col] ? table.columnDescriptions[col] : 'no description';

                    // Limit description length in header for readability
                    const shortDesc = desc.length > 60 ? desc.substring(0, 57) + '...' : desc;

                    return `
                        <th title="${desc.replace(/"/g, '&quot;')}" style="vertical-align: top; min-width: 150px;">
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">${name}</div>
                            <div style="font-weight: 400; font-size: 0.75rem; color: var(--text-muted); white-space: normal; line-height: 1.2;">
                                ${shortDesc === 'no description' ? '<span style="opacity: 0.5;">no description</span>' : shortDesc}
                            </div>
                        </th>`;
                }).join('');

                headRow.innerHTML = '<th style="vertical-align: top;">Index</th>' + colHeaders;
                thead.appendChild(headRow);
                tableEl.appendChild(thead);

                const tbody = document.createElement('tbody');
                table.rows.forEach(row => {
                    const tr = document.createElement('tr');
                    let html = `<td>${row.index}</td>`;
                    displayColumns.forEach(col => {
                        html += `<td>${row[col] || '-'}</td>`;
                    });
                    tr.innerHTML = html;
                    tbody.appendChild(tr);
                });
                tableEl.appendChild(tbody);

                tableWrapper.appendChild(tableEl);
                card.appendChild(tableWrapper);
                resultsDiv.appendChild(card);

                topScrollWrapper.onscroll = function () {
                    tableWrapper.scrollLeft = topScrollWrapper.scrollLeft;
                };
                tableWrapper.onscroll = function () {
                    topScrollWrapper.scrollLeft = tableWrapper.scrollLeft;
                };

                const resizeObserver = new ResizeObserver(() => {
                    topScrollDummy.style.width = tableEl.offsetWidth + 'px';
                    if (tableWrapper.offsetWidth >= tableEl.offsetWidth) {
                        topScrollWrapper.style.display = 'none';
                    } else {
                        topScrollWrapper.style.display = 'block';
                    }
                });
                resizeObserver.observe(tableEl);
                resizeObserver.observe(tableWrapper);
            });
        }

        downloadTxtBtn.addEventListener('click', () => {
            if (!lastScanData) return;

            let text = `SNMP SCAN RESULTS\n`;
            text += `Target: ${targetIp.value}\n`;
            text += `Date: ${new Date().toLocaleString()}\n`;
            text += `==========================================\n\n`;

            if (lastScanData.tables && lastScanData.tables.length > 0) {
                lastScanData.tables.forEach(table => {
                    // Filter columns logic (duplicating for download consistency)
                    let displayColumns = table.columns;
                    if (document.getElementById('hideNoDesc').checked) {
                        displayColumns = displayColumns.filter(col => {
                            const desc = table.columnDescriptions && table.columnDescriptions[col] ? table.columnDescriptions[col] : '';
                            return desc && desc.length > 0;
                        });
                    }
                    if (displayColumns.length === 0) return;

                    text += `DATA GROUP: ${table.oid}\n`;
                    text += `------------------------------------------\n`;

                    const colWidths = { index: 10 };
                    displayColumns.forEach(col => {
                        const name = table.columnNames && table.columnNames[col] ? table.columnNames[col] : `Col ${col}`;
                        colWidths[col] = Math.max(name.length, 15);
                    });

                    let header = `| ${'Index'.padEnd(colWidths.index)} | `;
                    displayColumns.forEach(col => {
                        const name = table.columnNames && table.columnNames[col] ? table.columnNames[col] : `Col ${col}`;
                        header += `${name.padEnd(colWidths[col])} | `;
                    });
                    text += header + `\n`;
                    text += `| ${'-'.repeat(colWidths.index)} | ` + displayColumns.map(col => '-'.repeat(colWidths[col])).join(' | ') + ` | \n`;

                    table.rows.forEach(row => {
                        let rowStr = `| ${String(row.index).padEnd(colWidths.index)} | `;
                        displayColumns.forEach(col => {
                            const val = String(row[col] || '-');
                            rowStr += `${val.padEnd(colWidths[col])} | `;
                        });
                        text += rowStr + `\n`;
                    });
                    text += `\n`;
                });
            } else if (lastScanData.raw && lastScanData.raw.length > 0) {
                text += `RAW OID RESULTS\n`;
                text += `------------------------------------------\n`;

                let scalarResults = lastScanData.raw;
                if (document.getElementById('hideNoDesc').checked) {
                    scalarResults = scalarResults.filter(r => r.description);
                }

                scalarResults.forEach(item => {
                    const namePart = item.name ? ` (${item.name})` : '';
                    text += `${item.oid}${namePart}: ${item.value}\n`;
                });
            }

            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `snmp_scan_${targetIp.value.replace(/\./g, '_')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        downloadCsvBtn.addEventListener('click', () => {
            if (!lastScanData) return;

            let csv = "";
            const escape = (val) => {
                if (val === null || val === undefined) return '""';
                let s = String(val).replace(/"/g, '""');
                return `"${s}"`;
            };

            if (lastScanData.tables && lastScanData.tables.length > 0) {
                lastScanData.tables.forEach(table => {
                    // Filter columns logic (duplicating for download consistency)
                    let displayColumns = table.columns;
                    if (document.getElementById('hideNoDesc').checked) {
                        displayColumns = displayColumns.filter(col => {
                            const desc = table.columnDescriptions && table.columnDescriptions[col] ? table.columnDescriptions[col] : '';
                            return desc && desc.length > 0;
                        });
                    }
                    if (displayColumns.length === 0) return;

                    csv += escape(`DATA GROUP: ${table.oid}`) + "\n";

                    // Header
                    let headerRow = ["Index"];
                    displayColumns.forEach(col => {
                        const name = table.columnNames && table.columnNames[col] ? table.columnNames[col] : `Col ${col}`;
                        headerRow.push(name);
                    });
                    csv += headerRow.map(escape).join(",") + "\n";

                    // Rows
                    table.rows.forEach(row => {
                        let dataRow = [row.index];
                        displayColumns.forEach(col => {
                            dataRow.push(row[col] || "");
                        });
                        csv += dataRow.map(escape).join(",") + "\n";
                    });
                    csv += "\n"; // Space between tables
                });
            } else if (lastScanData.raw && lastScanData.raw.length > 0) {
                let scalarResults = lastScanData.raw;
                if (document.getElementById('hideNoDesc').checked) {
                    scalarResults = scalarResults.filter(r => r.description);
                }

                csv += "OID,Name,Value\n";
                scalarResults.forEach(item => {
                    csv += `${escape(item.oid)},${escape(item.name || "")},${escape(item.value)}\n`;
                });
            }

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `snmp_scan_${targetIp.value.replace(/\./g, '_')}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    </script>
</body>

</html>