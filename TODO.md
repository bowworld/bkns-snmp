# TODO — bkns-snmp

## Критические исправления

- [x] **1. Закрыть уязвимость path traversal в `/api/telegraf/save`** ✅
  - Сервер теперь берёт только basename, санитизирует имя файла, пишет строго в `telegraf.d/`
  - Фронтенд отправляет `filename` вместо полного `path`
  - Проверено: `../../../etc/passwd` → rejected, `/etc/evil.conf` → пишет в `telegraf.d/evil.conf`

## Архитектура продукта

- [x] **2. Спроектировать модель данных multi-device + формат слепка** ✅
  - `site.json` — реестр площадки (site info, rooms, devices, polling)
  - `lib/site-manager.js` — CRUD модуль с миграцией из settings.json
  - API: 9 новых эндпоинтов `/api/site/*` + `/api/calculator`
  - Фронтенд: таб Site Setup (формы, таблицы, калькулятор размеров)
  - Автоматическая регистрация устройств при сохранении Telegraf конфига
  - Формат слепка спроектирован: tar.gz (meta.json + data.lp в InfluxDB Line Protocol)
  - Дизайн-документ: `docs/plans/2026-02-22-multi-device-snapshot-design.md`

- [ ] **3. Реализовать детекцию инцидентов**
  - Наблюдение за изменением дискретных значений (online → offline)
  - Пороги для числовых значений (температура выше нормы)
  - Правила: когда именно считать ситуацию инцидентом

- [ ] **4. Генерация слепков (snapshots)**
  - При срабатывании правила — сформировать файл-слепок
  - Содержимое: текущее состояние + time series между предыдущим и текущим слепком

- [ ] **5. Оповещения**
  - Email ответственному представителю заказчика
  - Письмо: описание инцидента + файл слепка во вложении

## Качество кода

- [ ] **6. Убрать захардкоженные секреты из docker-compose.yml**
  - Вынести токены, пароли в `.env` файл

- [ ] **7. Добавить аутентификацию на веб-интерфейс**
  - Любой в сети ЦОД может управлять системой

- [ ] **8. Добавить таймаут на SNMP walk**
  - Сейчас `session.subtree()` может висеть бесконечно

- [ ] **9. Улучшить Telegraf management**
  - Watchdog / автоперезапуск при падении
  - Персистентные логи

- [ ] **10. Автоматические тесты**
  - Хотя бы для MibManager и processToTables
  - ✅ SiteManager — 12 тестов (`test-site-manager.js`)
